<div class="form-page-container">
  <header class="form-header">
    <h1>{{ pageTitle }}</h1>
    <button type="button" (click)="cancel()" class="btn btn-link-secondary" [disabled]="isLoading">
      <i class="fas fa-arrow-left"></i> Voltar para a Lista de Rotas
    </button>
  </header>

  <div class="form-content">
    <div *ngIf="isLoading" class="loading-indicator">
      <i class="fas fa-spinner fa-spin"></i>
      {{ isEditMode ? 'Carregando dados da rota...' : 'Carregando pré-requisitos...'}}
    </div>

    <form [formGroup]="routeForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading" class="data-form">
      <div class="form-section">
        <h3 class="section-title">Informações Básicas da Rota</h3>
        <div class="form-row">
          <div class="form-field">
            <label for="nome">Nome da Rota <span class="required-asterisk">*</span></label> <input type="text" id="nome" formControlName="nome" placeholder="Ex: Rota Leste do Centro" [class.invalid-field]="routeForm.get('nome')?.invalid && routeForm.get('nome')?.touched"> <div *ngIf="routeForm.get('nome')?.invalid && routeForm.get('nome')?.touched" class="error-message"> <span *ngIf="routeForm.get('nome')?.errors?.['required']">O nome da rota é obrigatório.</span> <span *ngIf="routeForm.get('nome')?.errors?.['minlength']">Mínimo de 3 caracteres.</span>
              <span *ngIf="routeForm.get('nome')?.hasError('serverError')"> {{ routeForm.get('nome')?.errors?.['serverError'] }}
              </span>
            </div>
          </div>
          <div class="form-field">
            <label for="caminhaoId">Atribuir Caminhão <span class="required-asterisk">*</span></label> <select id="caminhaoId" formControlName="caminhaoId" [class.invalid-field]="routeForm.get('caminhaoId')?.invalid && routeForm.get('caminhaoId')?.touched"> <option [ngValue]="null" disabled>-- Selecione um Caminhão --</option>
              <option *ngFor="let truck of availableTrucks" [ngValue]="truck.id">
                {{ truck.placa }} (Motorista: {{ truck.nomeMotorista }}) </option>
            </select>
            <div *ngIf="routeForm.get('caminhaoId')?.invalid && routeForm.get('caminhaoId')?.touched" class="error-message"> <span *ngIf="routeForm.get('caminhaoId')?.errors?.['required']">A atribuição do caminhão é obrigatória.</span> <span *ngIf="routeForm.get('caminhaoId')?.hasError('serverError')"> {{ routeForm.get('caminhaoId')?.errors?.['serverError'] }}
              </span>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="tipoResiduo">Tipo de Resíduo <span class="required-asterisk">*</span></label> <select id="tipoResiduo" formControlName="tipoResiduo"
                    [class.invalid-field]="routeForm.get('tipoResiduo')?.invalid && routeForm.get('tipoResiduo')?.touched">
              <option [ngValue]="null" disabled>-- Selecione um Tipo de Resíduo --</option>
              <option *ngFor="let type of availableResidueTypes" [ngValue]="type">
                {{ type | titlecase }}
              </option>
            </select>
            <div *ngIf="routeForm.get('tipoResiduo')?.invalid && routeForm.get('tipoResiduo')?.touched" class="error-message">
              <span *ngIf="routeForm.get('tipoResiduo')?.errors?.['required']">O tipo de resíduo é obrigatório.</span>
            </div>
          </div>
          <div class="form-field">
            <label for="origemId">Ponto de Origem <span class="required-asterisk">*</span></label> <select id="origemId" formControlName="origemId"
                    [class.invalid-field]="routeForm.get('origemId')?.invalid && routeForm.get('origemId')?.touched">
              <option [ngValue]="null" disabled>-- Selecione o Ponto de Origem --</option>
              <option *ngFor="let point of availableCollectionPoints" [ngValue]="point.id">
                {{ point.nome }} ({{ point.endereco }}) </option>
            </select>
            <div *ngIf="routeForm.get('origemId')?.invalid && routeForm.get('origemId')?.touched" class="error-message">
              <span *ngIf="routeForm.get('origemId')?.errors?.['required']">O ponto de origem é obrigatório.</span>
            </div>
          </div>
          <div class="form-field">
            <label for="destinoId">Ponto de Destino <span class="required-asterisk">*</span></label> <select id="destinoId" formControlName="destinoId"
                    [class.invalid-field]="routeForm.get('destinoId')?.invalid && routeForm.get('destinoId')?.touched">
              <option [ngValue]="null" disabled>-- Selecione o Ponto de Destino --</option>
              <option *ngFor="let point of availableCollectionPoints" [ngValue]="point.id">
                {{ point.nome }} ({{ point.endereco }}) </option>
            </select>
            <div *ngIf="routeForm.get('destinoId')?.invalid && routeForm.get('destinoId')?.touched" class="error-message">
              <span *ngIf="routeForm.get('destinoId')?.errors?.['required']">O ponto de destino é obrigatório.</span>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="isEditMode && currentRouteDetails" class="form-section route-summary">
        <h3 class="section-title">Resumo da Rota Atual</h3>
        <p><strong>Nome da Rota:</strong> {{ currentRouteDetails.nome }}</p> <p><strong>Caminhão Designado:</strong> {{ currentRouteDetails.caminhaoPlaca }}</p> <p><strong>Distância Total:</strong> {{ currentRouteDetails.distanciaTotalKm | number:'1.1-2' }} km</p> <p><strong>Tipo de Resíduo Atendido:</strong> {{ currentRouteDetails.tipoResiduo || 'N/D' }}</p> <p><strong>Caminho (Pontos Ordenados):</strong></p>
        <ul class="point-list">
            <li *ngFor="let parada of currentRouteDetails.paradas; let i = index"> {{ parada.ordem }}. {{ parada.pontoNome }} ({{ parada.pontoEndereco }}) </li>
        </ul>
        <p class="section-subtitle small-text">A atualização dos pontos selecionados ou do caminhão irá recalcular a rota ao salvar.</p>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="routeForm.invalid || isLoading" class="btn btn-primary">
          <i class="fas" [ngClass]="isLoading ? 'fa-spinner fa-spin' : (isEditMode ? 'fa-save' : 'fa-cogs')"></i>
          {{ isLoading ? 'Processando...' : (isEditMode ? 'Atualizar e Recalcular Rota' : 'Definir e Calcular Rota') }}
        </button>
        <button type="button" (click)="cancel()" class="btn btn-secondary" [disabled]="isLoading">
          <i class="fas fa-times-circle"></i> Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
